name: Build and Deploy (CD pipeline)

permissions:
    contents: read

on:
    # push:
    #     branches:
    #     - '*'
    # pull_request:
    #     branches:
    #     - main
    workflow_dispatch:
    # workflow_run:
    #     workflows: ["security-scan.yml"]
    #     types: [completed]

jobs:
    build-image:
        runs-on: ubuntu-latest
        permissions:
            packages: write
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        steps:
            -
                name: Checkout Code
                uses: actions/checkout@v4
            
            - 
                name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            - 
                name: Log in to GitHub Container Registry
                run: |
                    echo "${{ secrets.GITHUB_TOKEN }}" | \
                    docker login ghcr.io -u ${{ github.actor }} --password-stdin

            -
                name: Swapcase repository owner name
                id: string
                uses: ASzc/change-string-case-action@v1
                with:
                    string: ${{ github.repository_owner }}

            - 
                name: Build and push Docker image
                uses: docker/build-push-action@v5
                with:
                    context: .
                    file: Dockerfile
                    push: true
                    tags: |
                        ghcr.io/${{ steps.string.outputs.lowercase }}/spm:latest
                        ghcr.io/${{ steps.string.outputs.lowercase }}/spm:${{ github.sha }}
    
    deploy-to-render:
        needs: build-image
        runs-on: ubuntu-latest
        permissions:
            deployments: write
        env:
            LOG_FILE: deploy.log
            RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
            RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
            SERVER_NAME: ${{ secrets.SERVER_NAME }}
            DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        steps:
            - 
                name: Checkout code
                uses: actions/checkout@v4

            - 
                name: Trigger Render deployment
                uses: JorgeLNJunior/render-deploy@v1.4.7
                with:
                    service_id: ${{ env.RENDER_SERVICE_ID }}
                    api_key: ${{ env.RENDER_API_KEY }}
                    clear_cache: true
                    wait_deploy: true
                    github_deployment: true
                    deployment_environment: 'production'
                    github_token: ${{ env.GITHUB_TOKEN }}

            - 
                name: Extract deployment log summary
                id: log_summary
                if: always()
                run: |
                    if [ -f "$LOG_FILE" ]; then
                        echo "log_summary<<EOF" >> $GITHUB_OUTPUT
                        tail -n 30 $LOG_FILE >> $GITHUB_OUTPUT
                        echo "EOF" >> $GITHUB_OUTPUT
                    else
                        echo "log_summary=No log file found" >> $GITHUB_OUTPUT
                    fi

            - 
                name: Notify Email (Success)
                if: success()
                uses: dawidd6/action-send-mail@v4
                with:
                    server_address: ${{ secrets.SMTP_SERVER }}
                    server_port: 587
                    secure: false
                    username: ${{ secrets.SMTP_USERNAME }}
                    password: ${{ secrets.SMTP_PASSWORD }}
                    to: ${{ secrets.EMAIL_TO_LIST }}
                    from: "GitHub Actions - CD <no-reply@github.com>"
                    subject: "✅ Déploiement réussi — Production"
                    body: |
                        Le déploiement en production a réussi.

                        Server: ${{ env.SERVER_NAME }}
                        Deploy URL: ${{ env.DEPLOY_URL }}
                        Branch: ${{ github.ref }}
                        Commit: ${{ github.sha }}
                        Action: Déploiement standard
                        Healthcheck: OK ✅

            - 
                name: Notify Email (Failure / Rollback)
                if: failure()
                uses: dawidd6/action-send-mail@v4
                with:
                    server_address: ${{ secrets.SMTP_SERVER }}
                    server_port: 587
                    secure: false
                    username: ${{ secrets.SMTP_USERNAME }}
                    password: ${{ secrets.SMTP_PASSWORD }}
                    to: ${{ secrets.EMAIL_TO_LIST }}
                    from: "GitHub Actions - CD <no-reply@github.com>"
                    subject: "⚠️ Échec du déploiement — Rollback effectué"
                    body: |
                        ⚠️ Le déploiement en production a échoué.
                        Un rollback automatique a été effectué.

                        Server: ${{ env.SERVER_NAME }}
                        Branch: ${{ github.ref }}
                        Commit en échec: ${{ github.sha }}
                        Action: Rollback automatique
                        Healthcheck: FAILED ❌

                        ${{ steps.log_summary.outputs.log_summary }}

                        Merci de consulter les logs GitHub Actions pour plus de détails.

