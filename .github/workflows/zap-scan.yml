---
name: OZVS (OWASP ZAP Vulnerability Scanner)

on:
    push:
        branches:
            - '**'
    pull_request:
        branches:
            - main
    workflow_dispatch:
    workflow_run:
        workflows: ["ci.yml"]
        types: [completed]

permissions:
    contents: read
    security-events: write
    issues: write

jobs:
    zap-api-scan:
        runs-on: ubuntu-latest
        steps:
            -
                name: Checkout Code
                uses: actions/checkout@v6
                with:
                    fetch-depth: 0

            - 
                name: Create api-scan.conf file with full configuration
                run: |
                    echo -e "scan.policy\tdefault" > api-scan.conf
                    echo -e "url.baseurl\thttp://localhost:8080" >> api-scan.conf
                    echo -e "url.target\thttp://localhost:8080/openapi.json" >> api-scan.conf
                    echo -e "rule.sql_injection\ttrue" >> api-scan.conf
                    echo -e "rule.xss\ttrue" >> api-scan.conf
                    echo -e "scan.verbose\ttrue" >> api-scan.conf
                    echo -e "scan.delay\t500" >> api-scan.conf
                    echo -e "scan.timeout\t120" >> api-scan.conf
                    echo -e "scan.maxDepth\t5" >> api-scan.conf
                    echo -e "scan.ajaxSpider\ttrue" >> api-scan.conf
                    echo -e "scan.authentication\ttrue" >> api-scan.conf
                    echo -e "scan.alertFilter\tmedium,high" >> api-scan.conf

            -
                name: Build Docker Image
                run: |
                    docker build -f ./Dockerfile -t dev-sec-ops/api-rest-crud .

            - 
                name: Create Docker Network
                run: docker network create zap-net || true
            
            - 
                name: Run Application Container
                run: |
                    docker run -d --name api --network zap-net -p 8080:80 dev-sec-ops/api-rest-crud
            
            - 
                name: Pull ZAP OWASP Image
                run: docker pull zaproxy/zap-weekly

            - 
                name: Run ZAP API Scan
                run: |
                    docker run --rm --network zap-net -v $(pwd):/zap/wrk/:rw -t zaproxy/zap-weekly \
                    zap-api-scan.py -t http://api:80/openapi.json -f openapi
                continue-on-error: true

            -
                name: Run ZAP Full Scan
                uses: zaproxy/action-full-scan@v0.13.0
                with:
                    token: ${{ secrets.GITHUB_TOKEN }}
                    docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
                    target: http://api:80
                    cmd_options: '-a -J report.json'
                    format: sarif
                    output_file: zap-report.sarif
                    # allow_issue_writing: false

            - 
                name: Upload ZAP SARIF to GitHub
                uses: github/codeql-action/upload-sarif@v3
                with:
                    sarif_file: zap-report.sarif
            
            - 
                name: Stop Docker Container
                run: |
                    docker stop api || true
                    docker rm api || true
                    docker network rm zap-net || true

